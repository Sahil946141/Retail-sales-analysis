<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analysis - Retail Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0/dist/chartjs-chart-matrix.min.js"></script>

    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for sales page */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: var(--text-light);
        }

        .loading-spinner {
            border: 3px solid rgba(26, 188, 156, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--accent);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-message i {
            font-size: 1.2rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .category-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .category-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .category-revenue {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
        }
        
        .category-percentage {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .progress-container {
            margin-top: 15px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-chart-line"></i>
            <h2>Retail Analytics</h2>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item" data-page="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="menu-item" data-page="customers">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </div>
            <div class="menu-item active" data-page="sales">
                <i class="fas fa-shopping-cart"></i>
                <span>Sales</span>
            </div>
            <div class="menu-item" data-page="forecasts">
                <i class="fas fa-chart-bar"></i>
                <span>Forecasts</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Sales Analysis</h1>
            </div>
            <!-- <div class="header-center">
                <div class="filter-btn active" data-period="30">
                    <i class="fas fa-calendar"></i>
                    Last 30 Days
                </div>
                <div class="filter-btn" data-period="90">
                    <i class="fas fa-calendar"></i>
                    Last Quarter
                </div>
                <div class="filter-btn" data-period="365">
                    <i class="fas fa-calendar"></i>
                    Last Year
                </div>
                <div class="filter-btn" data-period="custom">
                    <i class="fas fa-calendar"></i>
                    Custom Range
                </div>
            </div> -->
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search...">
                </div>
                <div class="user-profile">
                    <div class="avatar">Ad</div>
                    <span>Admin</span>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Sales Analysis Page Content -->
            <div class="page active" id="sales">
                <!-- KPI Cards Section -->
                <div class="kpi-grid" id="kpi-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading KPIs...
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Sales Trend</div>
                            <div class="chart-actions">
                                <button class="chart-action-btn"><i class="fas fa-download"></i></button>
                                <button class="chart-action-btn"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading chart...
                            </div>
                            <canvas id="salesTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Daily Sales Performance</div>
                            <div class="chart-actions">
                                <button class="chart-action-btn"><i class="fas fa-download"></i></button>
                                <button class="chart-action-btn"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading chart...
                            </div>
                            <canvas id="dailySalesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Categories Section -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Top Categories</div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i></button>
                            <button class="chart-action-btn"><i class="fas fa-expand"></i></button>
                        </div>
                    </div>
                    <div id="categories-container">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading categories...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer -->
        <div class="footer">
            <p>© Retail Analytics 2025 | All Rights Reserved</p>
        </div>
    </div>

  <script>
    // API endpoints
    const API_BASE = 'http://localhost:5000';
    const KPI_API = `${API_BASE}/api/analytics/kpis`;
    const TRENDS_API = `${API_BASE}/api/analytics/trends`;
    const DAILY_SALES_API = `${API_BASE}/api/analytics/daily-sales`;
    const TOP_CATEGORIES_API = `${API_BASE}/api/products/top/categories`;

    // Chart instances
    let salesTrendChart = null;
    let dailySalesChart = null;

    // DOM elements
    const kpiContainer = document.getElementById('kpi-container');
    const categoriesContainer = document.getElementById('categories-container');

    // Current filter
    let currentPeriod = 30;

    // Load all sales page data
    document.addEventListener('DOMContentLoaded', () => {
        loadSalesPageData();
        setupNavigation();
        setupFilters();
    });

    // -------------------- Navigation Setup --------------------
    function setupNavigation() {
        const menuItems = document.querySelectorAll('.menu-item');
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const sidebar = document.querySelector('.sidebar');
        
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                
                // Update active menu item
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Redirect to the corresponding page
                if (pageId === 'home') {
                    window.location.href = 'home.html';
                } else if (pageId === 'customers') {
                    window.location.href = 'customersegmentation.html';
                } else if (pageId === 'sales') {
                    window.location.href = 'sales.html';
                } else if (pageId === 'forecasts') {
                    window.location.href = 'Forecast.html';
                }
                
                // Close sidebar on mobile after selection
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                }
            });
        });
        
        // Mobile menu toggle
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
        }
    }

    // -------------------- Load Page Data --------------------
    async function loadSalesPageData() {
        try {
            await loadKPIs();
            await loadSalesTrendData();
            await loadDailySalesData();
            await loadTopCategoriesData();
        } catch (error) {
            console.error('Error loading sales page data:', error);
            showError('Failed to load sales data. Please try again later.');
        }
    }

    // -------------------- Load KPIs --------------------
    async function loadKPIs() {
        try {
            const res = await fetch(KPI_API);
            const result = await res.json();
            const data = result.data;

            const kpiData = [
                { title: "Total Sales", value: `₹${data.totalRevenue.toLocaleString()}`, trend: "", icon: "₹" },
                { title: "Orders", value: data.totalTransactions.toLocaleString(), trend: "", icon: "fas fa-shopping-cart" },
                { title: "Average Order Value", value: `₹${data.averageOrderValue.toFixed(2)}`, trend: "", icon: "fas fa-receipt" },
                
            ];

            kpiContainer.innerHTML = '';
            kpiData.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'kpi-card';
                const trendClass = kpi.trend.includes('-') ? 'negative' : '';
                const trendIcon = kpi.trend.includes('-') ? 'fas fa-arrow-down' : 'fas fa-arrow-up';
                card.innerHTML = `
                    <div class="kpi-header">
                        <div class="kpi-title">${kpi.title}</div>
                        <div class="kpi-icon"><i class="${kpi.icon}"></i></div>
                    </div>
                    <div class="kpi-value">${kpi.value}</div>
                    <div class="kpi-trend ${trendClass}"><i class="${trendIcon}"></i> <span>${kpi.trend}</span></div>
                `;
                kpiContainer.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading KPIs:', error);
            showEmptyState(kpiContainer, 'Failed to load KPI data');
        }
    }

    // -------------------- Load Sales Trend Data --------------------
    async function loadSalesTrendData() {
        try {
            const res = await fetch(TRENDS_API);
            const result = await res.json();
            const data = result.data;

            const labels = data.map(item => `${item.year}-${item.month.toString().padStart(2, '0')}`);
            const revenueData = data.map(item => parseFloat(item.revenue));
            const transactionData = data.map(item => parseInt(item.transactions));

            // Hide loading
            document.querySelector('#salesTrendChart').closest('.chart-wrapper').querySelector('.loading').style.display = 'none';

            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            if (salesTrendChart) salesTrendChart.destroy();
            salesTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: 'rgba(26, 188, 156, 1)',
                            backgroundColor: 'rgba(26, 188, 156, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Transactions',
                            data: transactionData,
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Revenue (₹)' }
                        },
                        y1: {
                            position: 'right',
                            beginAtZero: true,
                            title: { display: true, text: 'Transactions' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading sales trend data:', error);
            document.querySelector('#salesTrendChart').closest('.chart-wrapper').querySelector('.loading').style.display = 'none';
            showEmptyChart('salesTrendChart', 'No data available');
        }
    }

    // -------------------- Load Daily Sales Data --------------------
    // -------------------- Load Daily Sales Data --------------------
async function loadDailySalesData() {
    try {
        const res = await fetch(DAILY_SALES_API);
        const result = await res.json();
        
        // Check the actual structure of the response
        console.log('Daily Sales API Response:', result);
        
        // Handle different possible response structures
        let data;
        if (result.data && Array.isArray(result.data)) {
            data = result.data;
        } else if (Array.isArray(result)) {
            data = result;
        } else {
            throw new Error('Invalid data format from API');
        }

        // Extract labels and sales data
        const labels = data.map(item => {
            // Handle different date field names
            return item.date || item.Date || item.day || 'Unknown';
        });
        
        const salesData = data.map(item => {
            // Handle different sales field names
            return parseFloat(item.total_sales || item.totalSales || item.sales || item.revenue || 0);
        });

        // Hide loading
        const loadingElement = document.querySelector('#dailySalesChart').closest('.chart-wrapper').querySelector('.loading');
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }

        const ctx = document.getElementById('dailySalesChart').getContext('2d');
        if (dailySalesChart) dailySalesChart.destroy();
        
        dailySalesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Sales',
                    data: salesData,
                    backgroundColor: 'rgba(155, 89, 182, 0.7)',
                    borderColor: 'rgba(155, 89, 182, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'Sales (₹)' } 
                    },
                    x: { 
                        grid: { display: false },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading daily sales data:', error);
        const loadingElement = document.querySelector('#dailySalesChart').closest('.chart-wrapper').querySelector('.loading');
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
        showEmptyChart('dailySalesChart', 'No daily sales data available');
    }
}

    // -------------------- Load Top Categories Data --------------------
    async function loadTopCategoriesData() {
        try {
            const res = await fetch(TOP_CATEGORIES_API);
            const result = await res.json();
            const data = result.data;

            // Hide loading
            document.querySelector('#categories-container .loading').style.display = 'none';

            // Calculate total revenue for percentage calculation
            const totalRevenue = data.reduce((sum, cat) => sum + parseFloat(cat.total_revenue), 0);

            // Create category cards
            categoriesContainer.innerHTML = '';
            data.forEach(category => {
                const revenue = parseFloat(category.total_revenue);
                const percentage = ((revenue / totalRevenue) * 100).toFixed(1);
                
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <div class="category-header">
                        <div class="category-name">${category.category}</div>
                        <div class="category-percentage">${percentage}%</div>
                    </div>
                    <div class="category-revenue">₹${revenue.toLocaleString()}</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Revenue Share</span>
                            <span>${percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
                categoriesContainer.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading top categories data:', error);
            document.querySelector('#categories-container .loading').style.display = 'none';
            showEmptyState(categoriesContainer, 'Failed to load category data');
        }
    }

    // -------------------- Filter Setup --------------------
    function setupFilters() {
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPeriod = this.getAttribute('data-period');
                loadSalesPageData();
            });
        });
    }

    // -------------------- Utility Functions --------------------
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>${message}</span>`;
        document.querySelector('.content').insertBefore(errorDiv, document.querySelector('.page'));
        setTimeout(() => errorDiv.remove(), 5000);
    }

    function showEmptyState(container, message) {
        container.innerHTML = `<div class="empty-state"><i class="fas fa-chart-bar"></i><p>${message}</p></div>`;
    }

    function showEmptyChart(canvasId, message) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        ctx.font = '16px Arial';
        ctx.fillStyle = '#7f8c8d';
        ctx.textAlign = 'center';
        ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
    }
  </script>
</body>
</html>